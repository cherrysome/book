<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장소 대관 예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Canva 호환성 안내 섹션 -->
        <div class="bg-gradient-to-r from-blue-100 to-green-100 border border-blue-200 rounded-lg p-6 mb-6">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-blue-800 mb-3">🎯 예약 시스템 사용 안내</h2>
                
                <!-- 환경 감지 및 안내 -->
                <div id="environmentInfo" class="mb-4">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                
                <!-- 직접 예약 버튼 (Canva 외부에서만 표시) -->
                <div id="directReservationSection" style="display: none;">
                    <p class="text-blue-700 mb-4">바로 여기서 예약하실 수 있습니다!</p>
                    <button onclick="scrollToReservation()" 
                            class="bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-700 hover:to-green-700 text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg transform hover:scale-105 transition-all duration-200 mb-4">
                        📅 바로 예약하기
                    </button>
                </div>
                
                <!-- Canva 내부에서의 안내 -->
                <div id="canvaInstructions" style="display: none;">
                    <p class="text-purple-700 mb-4">Canva에서는 보안상 직접 예약이 제한됩니다.</p>
                    
                    <!-- 독립 페이지 링크 -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200 mb-4">
                        <h3 class="font-bold text-purple-800 mb-2">🔗 독립 예약 페이지</h3>
                        <p class="text-sm text-purple-700 mb-3">아래 링크를 복사해서 새 탭에서 열어주세요:</p>
                        <div class="bg-gray-100 p-3 rounded border text-sm font-mono break-all">
                            <span id="currentPageUrl"></span>
                        </div>
                        <button onclick="copyCurrentUrl()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mt-2 text-sm transition-colors">
                            📋 링크 복사
                        </button>
                    </div>
                    
                    <!-- 사용법 안내 -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200">
                        <h3 class="font-bold text-purple-800 mb-2">📋 사용 방법:</h3>
                        <div class="text-left text-sm text-purple-700 space-y-2">
                            <div class="flex items-start">
                                <span class="bg-purple-200 text-purple-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span>
                                <span>위의 링크를 복사</span>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-purple-200 text-purple-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span>
                                <span>새 탭에서 링크 열기</span>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-purple-200 text-purple-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span>
                                <span>독립 페이지에서 예약 진행</span>
                            </div>
                        </div>
                        
                        <!-- 특별 안내: Canva 임베드 URL인 경우 -->
                        <div id="embedUrlNotice" class="mt-3 bg-orange-50 border border-orange-200 rounded-lg p-3" style="display: none;">
                            <p class="text-orange-800 text-xs font-bold mb-1">⚠️ 임베드 URL 감지됨</p>
                            <p class="text-orange-700 text-xs">
                                현재 URL이 Canva 임베드 형태입니다.<br>
                                위의 변환된 독립 URL을 사용하거나, Canva에서 "웹사이트 게시" 기능을 이용해주세요.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- 기술적 한계 설명 -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-4">
                    <p class="text-yellow-800 text-sm">
                        💡 <strong>기술적 안내:</strong> Canva의 보안 정책으로 인해 내부에서는 외부 API 연결이 제한됩니다.<br>
                        독립 페이지에서는 모든 기능이 정상 작동합니다!
                    </p>
                </div>
            </div>
        </div>

        <!-- 관리자 전용 구글 시트 연동 설정 -->
        <div id="googleSheetSection" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6" style="display: none;">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">🔗 구글 시트 연동 설정 (관리자 전용)</h3>
            
            <!-- 단계별 안내 -->
            <div class="bg-white rounded-lg p-4 mb-4 border border-blue-200">
                <h4 class="font-semibold text-blue-800 mb-2">📋 설정 방법:</h4>
                <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                    <li><strong>구글 시트 열기:</strong> <a href="https://docs.google.com/spreadsheets/d/1FDCPdhGcVUoBxK9T4kb1YeVJCCnrOXj05kyTCfO8Zqs/edit" target="_blank" class="text-blue-600 underline hover:text-blue-800">여기를 클릭</a></li>
                    <li><strong>Apps Script 열기:</strong> 확장 프로그램 → Apps Script 클릭</li>
                    <li><strong>코드 붙여넣기:</strong> 아래 코드를 복사해서 붙여넣기</li>
                    <li><strong>배포하기:</strong> 배포 → 새 배포 → 웹 앱으로 배포</li>
                    <li><strong>URL 복사:</strong> 생성된 웹앱 URL을 아래에 입력</li>
                </ol>
                
                <!-- Canva/Netlify 특별 요구사항 -->
                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mt-3">
                    <h5 class="font-bold text-yellow-800 mb-2">🚨 Canva/Netlify 환경 필수 요구사항</h5>
                    <div class="text-yellow-700 text-sm space-y-2">
                        <div class="flex items-start">
                            <span class="bg-yellow-200 text-yellow-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span>
                            <div>
                                <p class="font-semibold">HTTPS 웹앱으로 배포 필수</p>
                                <p class="text-xs">HTTP는 작동하지 않습니다. 반드시 https://script.google.com/... URL이어야 함</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-yellow-200 text-yellow-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span>
                            <div>
                                <p class="font-semibold">액세스 권한: "모든 사용자" (Anyone) 필수</p>
                                <p class="text-xs">익명 사용자 접근이 허용되어야 Canva/Netlify에서 작동</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-yellow-200 text-yellow-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span>
                            <div>
                                <p class="font-semibold">최적화된 코드 사용</p>
                                <p class="text-xs">CORS 헤더 제거된 ContentService만 사용 (위 코드 적용)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- iframe 제한 경고 -->
                    <div class="bg-red-50 border border-red-300 rounded-lg p-3 mt-3">
                        <p class="text-red-800 font-bold text-sm mb-1">⚠️ iframe 환경 제한사항</p>
                        <p class="text-red-700 text-xs">
                            Google Apps Script는 iframe 기반 호스팅에서 CORS를 완벽히 지원하지 않습니다.<br>
                            <strong>독립 페이지에서는 정상 작동</strong>하지만, <strong>Canva 내부에서는 불안정</strong>할 수 있습니다.<br>
                            최상의 경험을 위해서는 "웹사이트 게시" 기능을 사용하세요.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 오류 해결 안내 -->
            <div class="bg-red-50 border border-red-300 rounded-lg p-4 mb-4">
                <h4 class="font-bold text-red-800 mb-2">🚨 연결 오류 해결 방법</h4>
                <div class="text-red-700 text-sm space-y-3">
                    
                    <!-- Failed to fetch 오류 -->
                    <div class="bg-orange-100 border border-orange-300 rounded p-3">
                        <p class="font-bold text-orange-800 mb-1">🔥 "Failed to fetch" 오류 (가장 흔한 오류):</p>
                        <p class="text-orange-700 mb-2">네트워크 요청이 차단되었습니다. Canva/Netlify 환경에서는 CORS 제한이 더 엄격합니다.</p>
                        <div class="bg-white border border-orange-200 rounded p-2 mt-2">
                            <p class="font-bold text-orange-800 text-xs mb-1">✅ Canva/Netlify 특화 해결법:</p>
                            <ul class="list-disc list-inside text-orange-700 text-xs space-y-1">
                                <li><strong>1단계:</strong> 위의 최적화된 코드 사용 (CORS 헤더 제거됨)</li>
                                <li><strong>2단계:</strong> Apps Script에서 기존 배포 모두 삭제</li>
                                <li><strong>3단계:</strong> 새 배포 생성 시 "액세스 권한: 모든 사용자" 필수!</li>
                                <li><strong>4단계:</strong> 권한 승인 시 "고급" → "안전하지 않은 페이지로 이동" 클릭</li>
                                <li><strong>5단계:</strong> iframe 환경에서는 여전히 불안정할 수 있음</li>
                            </ul>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mt-2">
                            <p class="text-yellow-800 text-xs font-bold">⚠️ 중요 안내:</p>
                            <p class="text-yellow-700 text-xs">
                                Google Apps Script는 iframe 기반 호스팅(Canva 등)에서 CORS를 완벽히 지원하지 않습니다.<br>
                                독립 페이지에서는 정상 작동하지만, Canva 내부에서는 제한될 수 있습니다.
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-100 border border-yellow-300 rounded p-3">
                        <p class="font-bold text-yellow-800 mb-1">⚠️ 302 오류 (로그인 리다이렉트):</p>
                        <p class="text-yellow-700">Apps Script가 로그인 페이지로 리다이렉트하고 있습니다. 배포 설정이 잘못되었거나 권한이 없습니다.</p>
                    </div>
                    
                    <p><strong>🔧 해결 방법 (순서대로 진행):</strong></p>
                    
                    <div class="bg-white border border-red-200 rounded p-3">
                        <p class="font-bold text-red-800 mb-2">1️⃣ 기존 배포 완전 삭제</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-red-600">
                            <li>Apps Script에서 "배포" → "배포 관리" 클릭</li>
                            <li>기존 배포가 있다면 <strong>모두 삭제</strong> (🗑️ 아이콘 클릭)</li>
                            <li>⚠️ 이 단계를 건너뛰면 302 오류가 계속 발생합니다!</li>
                        </ul>
                    </div>
                    
                    <div class="bg-white border border-red-200 rounded p-3">
                        <p class="font-bold text-red-800 mb-2">2️⃣ 새 배포 만들기 (Canva/Netlify 특화)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-red-600">
                            <li>"배포" → "새 배포" 클릭</li>
                            <li>⚙️ 설정 아이콘 클릭 → "웹 앱" 선택</li>
                            <li><span class="bg-yellow-200 px-2 py-1 rounded font-bold">실행 권한: "나"</span></li>
                            <li><span class="bg-green-200 px-2 py-1 rounded font-bold">액세스 권한: "모든 사용자"</span> ⭐ Canva/Netlify 필수!</li>
                            <li><span class="bg-blue-200 px-2 py-1 rounded font-bold">HTTPS 웹앱 URL 확인</span> (https://script.google.com/...)</li>
                            <li>"배포" 버튼 클릭</li>
                            <li>🔐 권한 승인 화면에서 "고급" → "안전하지 않은 페이지로 이동" 클릭</li>
                            <li>모든 권한 허용 (익명 사용자 접근 포함)</li>
                        </ul>
                        
                        <div class="bg-orange-50 border border-orange-200 rounded p-2 mt-2">
                            <p class="text-orange-800 text-xs font-bold">🚨 Canva/Netlify 환경 주의사항:</p>
                            <p class="text-orange-700 text-xs">
                                • "모든 사용자" 권한이 없으면 CORS 오류 발생<br>
                                • HTTP URL은 절대 작동하지 않음 (HTTPS 필수)<br>
                                • Content-Type: application/json 헤더 필수
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-red-200 rounded p-3">
                        <p class="font-bold text-red-800 mb-2">3️⃣ 중요한 확인사항</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-red-600">
                            <li>배포 후 생성된 URL이 <code>https://script.google.com/macros/s/...</code> 형태인지 확인</li>
                            <li>구글 시트 URL이 아닌 <strong>웹앱 URL</strong>을 사용해야 함</li>
                            <li>배포 시 "새 버전" 생성 확인</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Apps Script 코드 -->
            <div class="bg-gray-50 rounded-lg p-3 mb-4 border">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold text-gray-800">📝 최신 Apps Script 코드 (CORS 해결):</h4>
                    <button onclick="copyAppsScriptCode()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                        📋 복사
                    </button>
                </div>
                <textarea id="appsScriptCode" readonly class="w-full h-40 text-xs font-mono bg-white border rounded p-2 resize-none">// 🚨 Canva/Netlify 환경 최적화 코드
// 1. HTTPS 웹앱으로 배포 (HTTP 불가)
// 2. 액세스 권한: "모든 사용자" (Anyone) 필수
// 3. ContentService만 사용 (CORS 헤더 제거로 안정성 향상)

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('시트1'); // 시트 이름 정확히 입력
    
    if (data.reservations && Array.isArray(data.reservations)) {
      // 기존 데이터 삭제 후 새 데이터 입력
      sheet.clearContents();
      sheet.appendRow(['날짜', '시간', '예약자']); // 헤더 추가
      
      // 예약 데이터 추가
      data.reservations.forEach(row => {
        if (row && row.length >= 3) {
          sheet.appendRow(row);
        }
      });
      
      // 성공 응답 (JSON 형태로 반환)
      return ContentService
        .createTextOutput(JSON.stringify({ 
          success: true, 
          saved: data.reservations.length,
          timestamp: new Date().toISOString()
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // 데이터가 없는 경우
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: false, 
        error: 'No valid reservations data found' 
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (err) {
    // 오류 발생 시
    console.error('doPost 오류:', err);
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: false, 
        error: err.message,
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('시트1');
    
    // 시트에 데이터가 있는지 확인
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      // 헤더만 있거나 데이터가 없는 경우
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // 헤더 제외하고 데이터만 가져오기
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    // 빈 행 제거
    const filteredData = data.filter(row => 
      row[0] && row[1] && row[2] && 
      row[0].toString().trim() !== '' && 
      row[1].toString().trim() !== '' && 
      row[2].toString().trim() !== ''
    );
    
    return ContentService
      .createTextOutput(JSON.stringify(filteredData))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (err) {
    console.error('doGet 오류:', err);
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: err.message,
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</textarea>
            </div>

            <!-- URL 입력 -->
            <div class="flex flex-col md:flex-row gap-3 items-center">
                <input type="url" id="googleSheetUrl" placeholder="Apps Script 웹앱 URL을 입력하세요 (https://script.google.com/...)" 
                       class="flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="connectGoogleSheet()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    연결 테스트
                </button>
                <button onclick="loadFromGoogleSheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    데이터 불러오기
                </button>
            </div>
            
            <!-- 연결 상태 및 체크리스트 -->
            <div class="mt-2 text-sm">
                <p id="connectionStatus" class="text-red-700 font-medium">❌ 구글 시트 연결 안됨 - 로컬 저장만 가능</p>
                <p class="text-xs mt-1 text-blue-600">💡 Apps Script 웹앱 URL이 필요합니다 (구글 시트 URL이 아님)</p>
                
                <!-- 연결 실패 시 체크리스트 -->
                <div id="troubleshootingChecklist" class="mt-3 bg-orange-50 border border-orange-200 rounded-lg p-3" style="display: none;">
                    <p class="font-bold text-orange-800 text-sm mb-2">🔍 연결 실패 체크리스트:</p>
                    <div class="text-orange-700 text-xs space-y-1">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-2 text-orange-600"> 
                            <span>Apps Script 코드를 정확히 복사했나요?</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-2 text-orange-600"> 
                            <span>기존 배포를 모두 삭제했나요?</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-2 text-orange-600"> 
                            <span>액세스 권한을 "모든 사용자"로 설정했나요?</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-2 text-orange-600"> 
                            <span>권한 승인에서 "고급" → "안전하지 않은 페이지로 이동"을 클릭했나요?</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-2 text-orange-600"> 
                            <span>웹앱 URL을 사용하고 있나요? (구글 시트 URL이 아닌)</span>
                        </label>
                    </div>
                    <p class="text-orange-600 text-xs mt-2 font-medium">
                        ✅ 모든 항목을 체크한 후 다시 연결 테스트를 해보세요!
                    </p>
                </div>
            </div>
        </div>

        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🏆 대회전 멘토링 예약</h1>
            <p class="text-gray-600">2025년 8월 10일 ~ 9월 2일 | 오전 10시 ~ 오후 7시</p>
            <div class="mt-4 text-sm text-gray-700 space-y-2">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="mb-1">📍 <strong>멘토링장:</strong> 안양시 인재육성재단 1층 &lt;산토리니&gt; 강의실</p>
                    <p class="text-xs text-gray-600">(재단은 게임마에스터고등학교 샛별관에 있습니다.)</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-center mb-3">
                        <h3 class="text-lg font-bold text-green-800 mb-1">🏟️ 대회 운영 안내</h3>
                        <div class="w-16 h-0.5 bg-green-400 mx-auto"></div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-center bg-white rounded-lg p-2 shadow-sm">
                            <span class="text-green-700 font-medium">📍 장소: </span>
                            <span class="ml-2 font-semibold text-gray-800">평촌 중앙공원</span>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <p class="text-green-700 font-medium text-center mb-2">⏰ 경기 시간</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="bg-blue-50 rounded-lg p-2 text-center border border-blue-200">
                                    <div class="text-blue-700 font-semibold text-sm">초등부</div>
                                    <div class="text-blue-800 font-bold">12:00 - 13:00</div>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-2 text-center border border-purple-200">
                                    <div class="text-purple-700 font-semibold text-sm">고등부</div>
                                    <div class="text-purple-800 font-bold">15:00 - 18:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
